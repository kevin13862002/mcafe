<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>M Cafe Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: { scgreen: '#00704A' },
            fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] }
          }
        }
      };
    </script>
    <style>
      .bg-scgreen { background-color: #00704A !important; }
      .text-scgreen { color: #00704A !important; }
      .border-scgreen { border-color: #00704A !important; }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
      window.SUPABASE_URL = 'https://dqxgxjyliirsldztyelq.supabase.co';
      window.SUPABASE_ANON_KEY = 'sb_publishable_bZpsjO1rZ-y7URC8xn_IWw_PUwF1S8Y';
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.5/dist/umd/supabase.js"></script>
    <script src="./supabase-init.js"></script>
  </head>
  <body class="bg-gray-50 font-sans text-gray-800">
    <script>
      window.API_URL = window.API_URL || 'http://localhost:8000';
      window.adminSessionId = null;
    </script>
    <div id="admin-root" class="min-h-screen max-w-5xl mx-auto p-4 sm:p-6"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // Simple client-side password gate. Change ADMIN_PASSWORD before deploying.
      const ADMIN_PASSWORD = window.ADMIN_PASSWORD || 'admin123';

      function AdminApp(){
        const [unlocked, setUnlocked] = useState(false);
        const [products, setProducts] = useState([]);
        const [orders, setOrders] = useState([]);

        const [user, setUser] = useState(null);

        useEffect(() => {
        const saved = sessionStorage.getItem('adminSessionId');
        if(saved){
          window.adminSessionId = saved;
          setUnlocked(true);
          setUser({ email: sessionStorage.getItem('adminEmail') || 'Admin' });
        }
      }, []);

        useEffect(() => {
          if(!user) return;
          setUnlocked(true);
          fetchProducts();
          fetchOrders();
        }, [user]);

        async function fetchProducts(){
          try{
            if (!window.supabaseClient) {
              console.error('Supabase not initialized');
              return;
            }
            
            const { data, error } = await window.supabaseClient
              .from('products')
              .select('*')
              .order('id');
            
            if (error) throw error;
            setProducts(data || []);
          }catch(e){
            console.error('fetchProducts error:', e.message);
            alert('Could not load products');
          }
        }

        async function fetchOrders(){
          try{
            if (!window.supabaseClient) {
              console.error('Supabase not initialized');
              alert('Supabase not initialized. Please refresh the page.');
              return;
            }
            
            console.log('Fetching orders from Supabase...');
            const { data, error } = await window.supabaseClient
              .from('orders')
              .select('*')
              .order('created_at', { ascending: false });
            
            if (error) {
              console.error('Supabase error:', error);
              throw error;
            }
            console.log('Orders fetched:', data);
            setOrders(data || []);
          }catch(e){
            console.error('fetchOrders error:', e);
            alert(`Could not load orders: ${e.message || JSON.stringify(e)}`);
          }
        }

        async function addProduct(name, price, image){
          if(!name || !price) return alert('Name and price required');
          try{
            if (!window.supabaseClient) {
              console.error('Supabase not initialized');
              return;
            }
            
            const { data, error } = await window.supabaseClient
              .from('products')
              .insert([{ name, price: parseFloat(price), image, description: '' }])
              .select();
            
            if (error) throw error;
            alert('Product added!');
            fetchProducts();
          }catch(e){
            console.error('addProduct error:', e.message);
            alert('Failed to add product');
          }
        }

        async function updateProduct(id, updates){
          try{
            if (!window.supabaseClient) {
              console.error('Supabase not initialized');
              return;
            }
            
            const { data, error } = await window.supabaseClient
              .from('products')
              .update(updates)
              .eq('id', id)
              .select();
            
            if (error) throw error;
            fetchProducts();
          }catch(e){
            console.error('updateProduct error:', e.message);
            alert('Failed to update product');
          }
        }

        if(!unlocked) return <SignIn onSuccess={(u) => { setUser(u); setUnlocked(true); }} />;

        async function signOut(){
          try{
            if (window.supabaseClient) {
              await window.supabaseClient.auth.signOut();
            }
          }catch(e){
            console.error('signout error:', e);
          }
          sessionStorage.removeItem('adminSessionId');
          sessionStorage.removeItem('adminEmail');
          window.adminSessionId = null;
          setUser(null);
          setUnlocked(false);
        }

        return (
          <div>
            <header className="mb-6 flex items-center justify-between">
              <h1 className="text-2xl font-semibold">M Cafe — Admin</h1>
              <div className="flex items-center gap-3">
                {user && <div className="text-sm text-gray-600">{user.email}</div>}
                <button onClick={signOut} className="px-3 py-2 border rounded text-sm">Sign out</button>
              </div>
            </header>

            <section className="mb-8 bg-white p-4 rounded-lg shadow">
              <h2 className="text-lg font-medium mb-3">Product Manager</h2>
              <ProductForm onAdded={fetchProducts} addProduct={addProduct} />

                <div className="mt-6">
                <h3 className="font-medium mb-2">Existing Products</h3>
                <div className="space-y-2">
                  {products.map(p => (
                    <ProductRow key={p.id} p={p} onSave={(updates) => updateProduct(p.id, updates)} />
                  ))}
                </div>
              </div>
            </section>

            <section className="bg-white p-4 rounded-lg shadow">
              <h2 className="text-lg font-medium mb-3">Order History</h2>
              <div className="overflow-auto">
                <table className="w-full text-left text-sm">
                  <thead>
                    <tr className="text-gray-600">
                      <th className="p-2">ID</th>
                      <th className="p-2">Customer</th>
                      <th className="p-2">Items</th>
                      <th className="p-2">Total</th>
                      <th className="p-2">Requests</th>
                      <th className="p-2">Location</th>
                      <th className="p-2">Time</th>
                    </tr>
                  </thead>
                  <tbody>
                    {orders.map(o => {
                      let parsedItems = [];
                      try {
                        parsedItems = typeof o.items === 'string' ? JSON.parse(o.items) : o.items;
                      } catch (e) {
                        parsedItems = [];
                      }
                      
                      return (
                        <tr key={o.id} className="border-t">
                          <td className="p-2 align-top">{o.id}</td>
                          <td className="p-2 align-top">{o.customer_name || 'N/A'}</td>
                          <td className="p-2 align-top">
                            <div className="text-xs space-y-1">
                              {parsedItems.map((item, idx) => (
                                <div key={idx}>
                                  {item.name} x{item.qty} = ${((item.price || 0) * (item.qty || 0)).toFixed(2)}
                                </div>
                              ))}
                            </div>
                          </td>
                          <td className="p-2 align-top">${o.total}</td>
                          <td className="p-2 align-top">{o.requests || '-'}</td>
                          <td className="p-2 align-top">{o.location ? <a href={o.location} target="_blank" rel="noreferrer" className="text-scgreen">Map</a> : '-'}</td>
                          <td className="p-2 align-top">{o.created_at}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </section>
          </div>
        );
      }

      function ProductRow({p, onSave}){
        const [editing, setEditing] = useState(false);
        const [name, setName] = useState(p.name || '');
        const [price, setPrice] = useState(p.price || 0);
        const [image, setImage] = useState(p.image || '');

        function handleSave(){
          const pr = parseFloat(price);
          if(!name || name.trim().length === 0) return alert('Name required');
          if(!isFinite(pr) || pr <= 0) return alert('Enter a valid positive price');
          onSave({ name, price: pr, image });
          setEditing(false);
        }

        return (
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-gray-100 rounded overflow-hidden">
              {image ? <img src={image} alt="" className="w-full h-full object-cover" /> : null}
            </div>
            {!editing ? (
              <div className="flex-1">
                <div className="font-medium">{name}</div>
                <div className="text-sm text-gray-500">${price}</div>
              </div>
            ) : (
              <div className="flex-1 grid grid-cols-3 gap-2">
                <input value={name} onChange={e=>setName(e.target.value)} className="px-2 py-1 border rounded" />
                <input value={price} onChange={e=>setPrice(e.target.value)} className="px-2 py-1 border rounded" />
                <input value={image} onChange={e=>setImage(e.target.value)} className="px-2 py-1 border rounded" />
              </div>
            )}
            <div>
              {!editing ? (
                <button onClick={()=>setEditing(true)} className="px-3 py-1 border rounded">Edit</button>
              ) : (
                <button onClick={handleSave} className="px-3 py-1 bg-scgreen text-white rounded">Save</button>
              )}
            </div>
          </div>
        );
      }

      function ProductForm({onAdded, addProduct}){
        const [name, setName] = useState('');
        const [price, setPrice] = useState('');
        const [image, setImage] = useState('');
        const [loading, setLoading] = useState(false);

        async function submit(e){
          e.preventDefault();
          const pr = parseFloat(price);
          if(!name || name.trim().length === 0) return alert('Name is required');
          if(!isFinite(pr) || pr <= 0) return alert('Enter a valid price');
          setLoading(true);
          const ok = await addProduct(name, pr, image);
          setLoading(false);
          if(!ok) return;
          setName(''); setPrice(''); setImage('');
        }

        const valid = name.trim().length > 0 && isFinite(parseFloat(price)) && parseFloat(price) > 0;

        return (
          <form onSubmit={submit} className="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
            <div>
              <label className="block text-sm">Name</label>
              <input value={name} onChange={e=>setName(e.target.value)} className="mt-1 w-full px-3 py-2 border rounded" />
            </div>
            <div>
              <label className="block text-sm">Price</label>
              <input value={price} onChange={e=>setPrice(e.target.value)} type="number" step="0.01" className="mt-1 w-full px-3 py-2 border rounded" />
            </div>
            <div>
              <label className="block text-sm">Image URL</label>
              <input value={image} onChange={e=>setImage(e.target.value)} className="mt-1 w-full px-3 py-2 border rounded" />
            </div>
            <div className="sm:col-span-3">
              <button type="submit" disabled={!valid || loading} style={{backgroundColor: valid && !loading ? '#00704A' : '#ccc'}} className="px-4 py-2 text-white rounded disabled:opacity-60">{loading ? 'Adding…' : 'Add Product'}</button>
            </div>
          </form>
        );
      }

      function SignIn({onSuccess}){
        const [password, setPassword] = useState('');
        const [loading, setLoading] = useState(false);
        async function submit(e){
          e.preventDefault();
          if(!password || password.trim().length === 0) return alert('Password required');
          setLoading(true);
          try{
            const ADMIN_PASSWORD = window.ADMIN_PASSWORD || 'admin123';
            if(password !== ADMIN_PASSWORD){
              setLoading(false);
              return alert('Invalid password');
            }
            const sessionId = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());
            window.adminSessionId = sessionId;
            sessionStorage.setItem('adminSessionId', sessionId);
            sessionStorage.setItem('adminEmail', 'Admin');
            setLoading(false);
            onSuccess({ email: 'Admin' });
          }catch(e){
            setLoading(false);
            alert('Error: '+e.message);
          }
        }
        return (
          <div className="p-8 max-w-md mx-auto bg-white rounded shadow text-center">
            <h2 className="text-xl font-semibold mb-3">Admin Sign In</h2>
            <form onSubmit={submit} className="space-y-3">
              <input value={password} onChange={e=>setPassword(e.target.value)} placeholder="Password" type="password" className="w-full px-3 py-2 border rounded" />
              <div>
                <button type="submit" style={{backgroundColor: '#00704A'}} className="px-4 py-2 text-white rounded">Sign In</button>
              </div>
            </form>
            <div className="text-sm text-gray-500 mt-3">Enter the admin password configured on the server.</div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('admin-root')).render(<AdminApp />);
    </script>
  </body>
</html>
